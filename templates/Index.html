<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Drone</title>
  <!-- <script src="{{ url_for('static', filename="blockcode/acorn_interpreter.js") }}"></script> -->
  <script src="{{ url_for('static', filename="blockcode/blockly_compressed.js") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/blocks_compressed.js") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/blockly_compressed.js.map") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/blocks_compressed.js.map") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/flight.js") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/flight_code.js") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/move.js") }}"></script>
  <script src="{{ url_for('static', filename="blockcode/move_code.js") }}"></script>
  <script src="{{ url_for('static', filename="msg/js/en.js") }}"></script>
  <!-- bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
  <style>
    html{
      width: 100%;
      height: 100%;
    }
    body {
      width: 100%;
      height: 100%;
      background-color: #fff;
      font-family: sans-serif;
    }
    h1 {
      font-weight: normal;
      font-size: 100%;
      margin-bottom: 10px;
    }
    #blocklyDiv{
      border: 1px solid gray;
    }
    .all{
      width: 100%;
      height: 100%;
      margin-left: auto;
      margin-right: auto;
    }
    #Button{
      margin-top: 6px;
      margin-left: 2px;
      font-size:14px;
      /* width: auto;
      height: auto;
      font-size: 15px;
      padding: 2px;
      margin-right: 2px; */
    }
  </style>
</head>
<body>
  <h1>
    <button type="button" class="btn btn-info active" onclick="runCode()" id="Button">RUN</button>
    <button type="button" class="btn btn-info active" onclick="changeBtnName(this)" id="Button">Connect</button>
    <button type="button" class="btn btn-secondary disabled" onclick="save()" id="Button" style="margin-left: 20px;">Save</button>
    <button type="button" class="btn btn-secondary disabled" onclick="load()" id="Button">Load</button>
    <button type="button" class="btn btn-secondary disabled" onclick="remove()" id="Button">Remove</button>
    <button type="button" class="btn btn-secondary disabled" onclick="block_clear()" id="Button">Clear</button>
    <button type="button" class="btn btn-secondary" onclick="get_battery()" id="Button" style="float:right; margin-right: 20px;">Show Battery</button>
</h1>
<div>
  <section class="modal modal-section type-alert">
    <div class="enroll_box">
        <p class="menu_msg"></p>
    </div>
    <div class="enroll_btn">
        <button class="btn pink_btn modal_close">확인</button>
    </div>
</section>
</div>

  <div class="all">
    <div id="blocklyDiv"
      style="display: inline-block; height: 90%; width: 98%">
    </div>

    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
      <category name="Flight" colour="purple">
        <block type="takeoff"></block>
        <block type="land"></block>
      </category>
      <category name="Move" colour="blue">
        <block type="flight_move"></block>
        <block type="up"></block>
        <block type="down"></block>
        <block type="cw"></block>
        <block type="ccw"></block>
        <block type="flip"></block>
      </category>
      <!-- <category name="Logic" colour="%{BKY_LOGIC_HUE}">
        <block type="controls_if"></block>
        <block type="logic_compare"></block>
        <block type="logic_operation"></block>
        <block type="logic_negate"></block>
        <block type="logic_boolean"></block>
      </category> -->
      <category name="Loops" colour="%{BKY_LOOPS_HUE}">
        <block type="controls_repeat_ext">
          <value name="TIMES">
            <block type="math_number">
              <field name="NUM">10</field>
            </block>
          </value>
        </block>
        <!-- <block type="controls_whileUntil"></block> -->
      </category>
      <category name="Math" colour="%{BKY_MATH_HUE}">
        <block type="math_number">
          <field name="NUM">123</field>
        </block>
        <!-- <block type="math_arithmetic"></block>
        <block type="math_single"></block> -->
      </category>
      <!-- <category name="Text" colour="%{BKY_TEXTS_HUE}">
        <block type="text"></block>
        <block type="text_length"></block>
        <block type="text_print"></block>
        <block type="text_prompt_ext">
          <value name="TEXT">
            <block type="text"></block>
          </value>
        </block>
      </category> -->
      <sep></sep>
      <!-- <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}">
      </category>
      <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
      </category> -->
    </xml>

    <xml xmlns="https://developers.google.com/blockly/xml" id="startBlocks" style="display: none">
      <block type="variables_set" id="set_n_initial" inline="true" x="20" y="20">
        <field name="VAR">n</field>
        <value name="VALUE">
          <block type="math_number">
            <field name="NUM">1</field>
          </block>
        </value>
        <next>
          <block type="controls_repeat_ext" id="repeat" inline="true">
            <value name="TIMES">
              <block type="math_number">
                <field name="NUM">4</field>
              </block>
            </value>
            <statement name="DO">
              <block type="wait_seconds" id="wait">
                <field name="SECONDS">1.0</field>
                <next>
                  <block type="variables_set" id="set_n_update" inline="true">
                    <field name="VAR">n</field>
                    <value name="VALUE">
                      <block type="math_arithmetic" inline="true">
                        <field name="OP">MULTIPLY</field>
                        <value name="A">
                          <block type="variables_get">
                            <field name="VAR">n</field>
                          </block>
                        </value>
                        <value name="B">
                          <block type="math_number">
                            <field name="NUM">2</field>
                          </block>
                        </value>
                      </block>
                    </value>
                    <next>
                      <block type="text_print" id="print" inline="false">
                        <value name="TEXT">
                          <block type="variables_get">
                            <field name="VAR">n</field>
                          </block>
                        </value>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </statement>
          </block>
        </next>
      </block>
    </xml>
  </div>

  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',
      {
        media: '../static/media/',
        toolbox: document.getElementById('toolbox')
      });
  </script>
  <script>
    function runCode() { 
      var json = Blockly.serialization.workspaces.save(demoWorkspace);
      var obj_s = JSON.stringify(json, null, "\t");
      console.log(obj_s);

      // back-end에 json 보냄
      const request = new XMLHttpRequest();
      request.open('POST', 'http://localhost:5000/', true);
      request.setRequestHeader('Content-Type', 'application/json'); //x-www-form-urlencoded
      request.send(JSON.stringify(json));

    }
  </script>
  <script>
    // function connect(){
    //   const request = new XMLHttpRequest();
    //   request.open('GET', 'http://localhost:5000?id=connect', true);
    //   request.send();
    // }
    function disconnect(){
      const request = new XMLHttpRequest();
      request.open('GET', 'http://localhost:5000?id=disconnect', true); 
      request.send();
    }

    // 버튼 클릭 시 connect <-> disconnect 변경
    var flag = true;
    function changeBtnName(btn){
      flag = !flag;
      btn.innerHTML = flag ? 'Connect' : 'Disconnect';
      if(btn.innerHTML == 'Disconnect'){
        const html = '<div style="color:red"> Disconnect </div>';
        btn.innerHTML = html;

        $.ajax({
          type: "GET",
          url: 'http://localhost:5000?id=connect',
          data: {},
          success: function(connection_string){
            alert(connection_string);
          }
        })
      }
      else{
        const html = '<div style="color:default"> Connect </div>';
        btn.innerHTML = html;
        disconnect();
      }
    }
    function save(){  
      var json = Blockly.serialization.workspaces.save(demoWorkspace);
      var obj_s = JSON.stringify(json, null, "\t");
      console.log(window.localStorage.length);
      var input = prompt('key 값을 입력해주세요.');
      if(input != "" && window.localStorage.getItem(input)==null){
          window.localStorage.setItem(input, obj_s);
          console.log("key 값 : ", input, " 에 블록이 저장되었습니다.");
      }
      else if(input == "") {
        console.log("잘못된 key 값 입니다.")
      }
      else{
        var check = confirm('동일한 key 값이 존재합니다. 덮어씌우겠습니까?');
        if (check === true){
          window.localStorage.setItem(input, obj_s);
          console.log(input, "에 덮어씌어졌습니다.")
        } else {
          console.log("다른 key 값을 입력해주세요.");
        }
      }
    }
  
    function load(){
      var keys = new Array();
      for(let i=0; i<window.localStorage.length; i++){
        keys[i] = window.localStorage.key(i)
      }
      keys = String(keys)
      console.log("현재 존재하는 key 값:", keys)
      var input = prompt('key 목록: '+keys, '불러올 블럭의 key 값을 입력해주세요.');
      if(window.localStorage.getItem(input)){
          obj = JSON.parse(window.localStorage.getItem(input));
          Blockly.serialization.workspaces.load(obj, demoWorkspace);
          console.log("key 값 : ", input, " 의 블럭을 불러왔습니다");
        }
      else
          console.log("key 값이 존재 하지 않거나 잘못입력하였습니다."); 
    }
    function remove(){
      var keys = new Array();
      for(let i=0; i<window.localStorage.length; i++){
        keys[i] = window.localStorage.key(i);
      }
      keys = String(keys);
      console.log("현재 존재하는 key 값:", keys);
      var input = prompt('key 목록: '+keys, '삭제할 블럭의 key 값을 입력해주세요.');
      if(window.localStorage.getItem(input)){
        window.localStorage.removeItem(input);
        console.log(input, "이 삭제되었습니다.");
        }
      else
        console.log("key가 존재하지 않습니다.")
    }
    function block_clear(){
      var check = confirm('저장된 모든 블럭이 삭제됩니다. 삭제하시겠습니까?');
        if (check == true){
          window.localStorage.clear();
          console.log('저장된 모든 블럭이 삭제되었습니다.')
        }
    }
    
    function get_battery(){
      $.ajax({
        type: "GET",
        url: 'http://localhost:5000?id=battery',
        data: {},
        success: function(battery){
          alert('남은 배터리: ' + battery + ' %');
        }
      })
    }
  </script>
</body>
</html>